# API Contract: AI Agent + MCP Integration (Todo AI Assistant)

**Feature**: 008-ai-assistant-integration
**Created**: 2026-02-06
**Status**: Complete

## Agent Chat Endpoint: POST /api/{user_id}/agent/chat

### Description
Process a user message through the AI agent and return a response. This endpoint handles natural language processing, tool calling, and real-time updates to todo items.

### Authentication
- **Type**: JWT Bearer Token
- **Required**: Yes
- **Header**: `Authorization: Bearer <jwt_token>`
- **Validation**: Token must be valid and user_id in token must match user_id in URL

### Request Parameters

#### Path Parameters
- **user_id** (string, required)
  - Format: UUID
  - Description: ID of the authenticated user
  - Validation: Must match authenticated user's ID

#### Request Body
```json
{
  "message": {
    "type": "string",
    "required": true,
    "min_length": 1,
    "max_length": 1000,
    "description": "The user's message to the AI assistant"
  },
  "session_id": {
    "type": "string",
    "format": "uuid",
    "required": false,
    "description": "Optional ID of existing conversation session"
  },
  "model_preferences": {
    "type": "object",
    "required": false,
    "description": "Optional preferences for AI model behavior",
    "properties": {
      "temperature": {
        "type": "number",
        "minimum": 0.0,
        "maximum": 1.0,
        "description": "Controls randomness in response generation"
      }
    }
  }
}
```

### Response Codes
- **200 OK**: Successfully processed message and generated response
- **400 Bad Request**: Invalid request parameters or message content
- **401 Unauthorized**: Missing or invalid authentication token
- **403 Forbidden**: User attempting to access another user's agent
- **422 Unprocessable Entity**: Invalid message content or request structure
- **429 Too Many Requests**: Rate limit exceeded
- **500 Internal Server Error**: Server error during agent processing

### Success Response (200 OK)
```json
{
  "session_id": "string (uuid)",
  "response": "string",
  "timestamp": "string (ISO 8601 datetime)",
  "tool_calls": [
    {
      "id": "string",
      "type": "string (function)",
      "function": {
        "name": "string",
        "arguments": "string (JSON)"
      }
    }
  ],
  "tool_results": [
    {
      "call_id": "string",
      "output": "string (JSON)",
      "is_error": "boolean"
    }
  ],
  "updated_todos": [
    {
      "id": "string (uuid)",
      "title": "string",
      "description": "string",
      "completed": "boolean",
      "created_at": "string (ISO 8601 datetime)",
      "updated_at": "string (ISO 8601 datetime)"
    }
  ]
}
```

### Error Response (4xx/5xx)
```json
{
  "error": "string",
  "code": "string",
  "message": "string",
  "details": "object (optional)"
}
```

### Examples

#### Successful Request
```
POST /api/a1b2c3d4-e5f6-7890-1234-567890abcdef/agent/chat
Authorization: Bearer <valid_jwt_token>
Content-Type: application/json

{
  "message": "Add a task to buy groceries",
  "model_preferences": {
    "temperature": 0.7
  }
}
```

#### Successful Response
```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "session_id": "f0e9d8c7-b6a5-4321-fedc-ba9876543210",
  "response": "I've added a task 'Buy groceries' to your list.",
  "timestamp": "2026-02-06T10:30:45.123Z",
  "tool_calls": [
    {
      "id": "call_add123",
      "type": "function",
      "function": {
        "name": "add_todo",
        "arguments": "{\"title\":\"Buy groceries\",\"description\":\"\"}"
      }
    }
  ],
  "tool_results": [
    {
      "call_id": "call_add123",
      "output": "{\"success\":true,\"todo\":{\"id\":\"z9y8x7w6-v5u4-3210-t9s8-r7q6p5o4n3m2\",\"title\":\"Buy groceries\",\"completed\":false,\"created_at\":\"2026-02-06T10:30:45.123Z\"}}",
      "is_error": false
    }
  ],
  "updated_todos": [
    {
      "id": "z9y8x7w6-v5u4-3210-t9s8-r7q6p5o4n3m2",
      "title": "Buy groceries",
      "description": "",
      "completed": false,
      "created_at": "2026-02-06T10:30:45.123Z",
      "updated_at": "2026-02-06T10:30:45.123Z"
    }
  ]
}
```

## Agent Session Management Endpoints

### GET /api/{user_id}/agent/sessions

#### Description
Retrieve all agent sessions for the specified user, ordered by most recent activity.

#### Authentication
- **Type**: JWT Bearer Token
- **Required**: Yes

#### Response
- **200 OK**: List of user's agent sessions
- **401 Unauthorized**: Invalid authentication
- **403 Forbidden**: User mismatch
- **500 Internal Server Error**: Server error

```json
{
  "sessions": [
    {
      "id": "string (uuid)",
      "title": "string",
      "created_at": "string (ISO 8601 datetime)",
      "updated_at": "string (ISO 8601 datetime)",
      "message_count": "integer"
    }
  ]
}
```

### GET /api/{user_id}/agent/sessions/{session_id}

#### Description
Retrieve a specific agent session and its message history.

#### Authentication
- **Type**: JWT Bearer Token
- **Required**: Yes

#### Response
- **200 OK**: Session and messages
- **401 Unauthorized**: Invalid authentication
- **403 Forbidden**: User doesn't own session
- **404 Not Found**: Session doesn't exist
- **500 Internal Server Error**: Server error

```json
{
  "session": {
    "id": "string (uuid)",
    "title": "string",
    "created_at": "string (ISO 8601 datetime)",
    "updated_at": "string (ISO 8601 datetime)"
  },
  "messages": [
    {
      "id": "string (uuid)",
      "role": "string (user|assistant|tool)",
      "content": "string",
      "timestamp": "string (ISO 8601 datetime)",
      "tool_calls": "array (optional)",
      "tool_results": "array (optional)"
    }
  ]
}
```

### DELETE /api/{user_id}/agent/sessions/{session_id}

#### Description
Delete a specific agent session and all its messages.

#### Authentication
- **Type**: JWT Bearer Token
- **Required**: Yes

#### Response
- **204 No Content**: Successfully deleted
- **401 Unauthorized**: Invalid authentication
- **403 Forbidden**: User doesn't own session
- **404 Not Found**: Session doesn't exist
- **500 Internal Server Error**: Server error

## Common Error Responses

### 400 Bad Request
```json
{
  "error": "Invalid request parameters",
  "code": "INVALID_PARAMS",
  "message": "Message content is required and cannot exceed 1000 characters",
  "details": {
    "errors": [
      {
        "field": "message",
        "message": "Message content is required",
        "value": ""
      }
    ]
  }
}
```

### 401 Unauthorized
```json
{
  "error": "Authentication required",
  "code": "AUTH_REQUIRED",
  "message": "Valid JWT token is required for this operation"
}
```

### 403 Forbidden
```json
{
  "error": "Access denied",
  "code": "ACCESS_DENIED",
  "message": "User does not have access to this agent session",
  "details": {
    "reason": "User does not own this session"
  }
}
```

### 429 Too Many Requests
```json
{
  "error": "Rate limit exceeded",
  "code": "RATE_LIMIT_EXCEEDED",
  "message": "Too many requests. Please try again later.",
  "details": {
    "retry_after": 60
  }
}
```

### 500 Internal Server Error
```json
{
  "error": "Internal server error",
  "code": "INTERNAL_ERROR",
  "message": "An unexpected error occurred during agent processing",
  "details": {
    "error_id": "string (for support reference)"
  }
}
```

## Security Requirements

- JWT token validation required for all endpoints
- Cross-user session access prevented via user_id validation
- Input sanitization for all message content
- Proper authorization checks for all operations
- Rate limiting to prevent abuse of agent services

## Performance Requirements

- Agent responses delivered within 5 seconds for 95% of requests
- Support for 100+ concurrent agent sessions
- Message history retrieval under 1 second for typical session lengths
- Tool execution logging with minimal performance impact